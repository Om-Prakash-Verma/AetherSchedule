rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is an Admin
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Data Validation Helpers
    function isValidString(text) {
      return text is string && text.size() > 0 && text.size() < 1000;
    }
    
    function isValidScheduleEntry() {
      let data = request.resource.data;
      return data.keys().hasAll(['day', 'slot', 'subjectId', 'roomId', 'batchId']) &&
             data.slot is number &&
             isValidString(data.day);
    }

    // --- RULES ---

    // Admins Collection:
    // Split get (single doc) and list (collection query) to ensure clarity for the rules engine.
    match /admins/{userId} {
      // Allow reading specific admin doc if it's you OR if you are an admin
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Allow listing all admins ONLY if you are an admin
      allow list: if isAdmin();
      
      // Write only if admin
      allow write: if isAdmin();
    }

    // Settings: Public Read (for portal config), Admin Write
    match /settings/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Schedule: Public Read (Timetable view), Admin Write (with validation)
    match /schedule/{entryId} {
      allow read: if true;
      allow create, update: if isAdmin() && isValidScheduleEntry();
      allow delete: if isAdmin();
    }

    // Resources (Faculty, Rooms, etc.): Public Read (for portals), Admin Write
    match /faculty/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /rooms/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /subjects/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /batches/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /departments/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Schedule Versions: Admin only
    match /schedule_versions/{document=**} {
      allow read, write: if isAdmin();
    }
  }
}